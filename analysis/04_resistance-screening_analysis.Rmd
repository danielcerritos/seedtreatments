---
title: "Resistance screening analysis"
author: "Daniel Cerritos"
date: "4/6/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
```

## Import data

```{r import screening data}
(screening.data <- list.files(path = here("output", "clean_data"), 
                         full.names = TRUE, pattern = "screening"))

layer.test <- read.csv(screening.data[1])
tray.test <- read.csv(screening.data[2])
rps.greenhouse <- read.csv(screening.data[3])
rps.incubator <- read.csv(screening.data[4])
```

## Resistance gene (Rps) screening 

### Greenhouse trial

```{r greenhouse trial}
rps.greenhouse <- rps.greenhouse %>% 
  filter(dai == "dai.10") %>% 
  mutate(incidence = (dead_seedlings/total_seedlings)*100) %>% 
  group_by(isolate, line) %>% 
  summarise(mean_incidence = round(mean(incidence))) %>% 
  mutate(reaction = case_when(
    mean_incidence >= 75 ~ "S", # susceptible reaction
    mean_incidence <= 25 ~ "R", # resistant
    TRUE ~ "I")) # intermediate 

reaction.results <- rps.greenhouse %>% 
  select(-mean_incidence) %>% 
  spread(isolate, reaction) %>% 
  select(line, OH1, OH3, OH4, OH7, OH25, OH28) 

incidence.results <- rps.greenhouse %>% 
  select(-reaction) %>% 
  spread(isolate, mean_incidence) %>% 
  select(line, OH1, OH3, OH4, OH7, OH25, OH28) 

gh.controls <- c("harlon", "harosoy", "williams79", 
              "williams82", "williams", "harosoy62xx", 
              "harosoy13xx", "sloan", "L83-570")

reaction.results %>% 
  filter(line %in% gh.controls) 
```

overrall, checks are having a susceptible reaction
OHR1 and OH28 resistant check was included and had the expected reaction

```{r GH Rps discovery}
# all lines are susceptible to OH25 (1a, 1b, 1c, 1k)
(assign.rps <- reaction.results %>% 
  filter(!line %in% gh.controls) %>% 
  mutate(Rps = case_when(
    OH1 == "S" ~ "rps",
    OH1 == "R" & OH4 == "S" & (OH3 == "R" | OH7 == "R") ~ "Rps1c", 
    OH1 == "R" & OH3 == "R" & OH4 == "R" & OH7 == "R" ~ "Rps1k", 
    OH1 == "R" & (OH3 == "S" | OH4 == "S" | OH7 == "S") ~ "Rps1a")
    ))
```

- many intermediate reactions to be able to assign a Rps gene  

- most lines with an intermediate reaction to OH1 are susceptible to at least 3 other isolates  
with the exception of LD09-30224 and LD12-15129

- I will assign no resistance gene to these lines except to the mention above

- Lets look the lines with a R reactions and no gene was asign 

```{r gh rps discovery 2.0}
lines.R.OH1 <- assign.rps %>% 
  filter(OH1 == "R", is.na(Rps)) %>%
  select(line)

lines.R.OH1 <- lines.R.OH1$line

incidence.results %>% 
  filter(line %in% lines.R.OH1)
```

Although no consistent R reactions to assign a gene, I will asign one based on what is closer

```{r gh final Rps genes}
rps1a <- c("LD09-30224", "LD11-2170", "LD12-15246R2a")
rps1c <- c("LD13-13334R1a", "LD12-15129R1a")
rps1k <- c("LD11-13802R2", "LD11-7311")

(rps.gh <- reaction.results %>% 
  filter(!line %in% gh.controls) %>% 
  mutate(Rps = case_when(
    OH1 == "R" & OH4 == "S" & (OH3 == "R" | OH7 == "R") | line %in% rps1c ~ "Rps1c", 
    OH1 == "R" & (OH3 == "S" | OH4 == "S" | OH7 == "S") | line %in% rps1a ~ "Rps1a", 
    OH1 == "S" | OH1 == "I" ~ "rps" ,
    line %in% rps1k ~ "Rps1k"))
)
```

### Incubator trial: rag rolls 

- Isolates 0H1, OH3 and OH4 were used to confirm presence of gene.
- lines that were susceptible to OH1 were not inoculated with OH3 and OH4

```{r incubator trial}
rps.incubator <- rps.incubator %>% 
  mutate(incidence = (dead_seedlings/total_seedlings)*100) %>% 
  group_by(isolate, line) %>% 
  summarise(mean_incidence = round(mean(incidence))) %>% 
  mutate(reaction = case_when(
    mean_incidence >= 75 ~ "S", 
    mean_incidence <= 25 ~ "R", 
    TRUE ~ "I"
  ))

inc.reaction <- rps.incubator %>% 
  select(-mean_incidence) %>% 
  spread(isolate, reaction)

inc.incidence <- rps.incubator %>% 
  select(-reaction) %>% 
  spread(isolate, mean_incidence)

inc.controls <- c("Harlon (Rps1a)", "Harosoy (Rps7)", "Harosoy 13x (Rps1b)", 
              "Harosoy 62XX (Rps6)", "Williams (rps)", "Williams 79 (Rps1c)")

rps.inc <- inc.reaction %>%
  filter(!line %in% inc.controls) %>% 
  mutate(Rps = case_when(
    OH1 == "R" & OH3 == "R" & (OH4 == "S" | OH4 == "I") ~ "Rps 1c", 
    OH1 == "R" & OH3 == "S" & OH4 == "S" ~ "Rps 1a", 
    OH1 == "R" & OH3 == "R" & OH4 == "R" ~ "Rps 1k", 
    OH1 == "S" ~ "rps", 
    TRUE ~ "rps")
    )

```

Lets compare results from both trials and assign final Rps

```{r compare rps trials }

rps.gh <- rps.gh %>% 
  select(line, Rps) %>% 
  filter(!line %in% gh.controls)

rps.inc <- rps.inc %>% 
  select(line, Rps) %>% 
  filter(!line %in% inc.controls)

(rps.final <- bind_cols(rps.gh, rps.inc))
```

Most of the results form the two trials match, with the exception of Rps1a  
Lest check the intermediate results of those lines 

```{r}

```


















## Partial resistance screening

```{r layer test scores}
str(layer.test)
hist(layer.test$scale_dorrance) # most scores are b/w 4-7 (moderate to low levels)

# mean for layer test and clasify as High, Moderate or Low based on the score mean
mean.scores <- layer.test %>% 
  group_by(line) %>% 
  summarise(mean(scale_dorrance)) 

mean.scores %>% 
  rename(mean_score = `mean(scale_dorrance)`)%>% 
  mutate(
    pr_level = case_when(
      mean_score <= 4 ~ "High", 
      mean_score >= 6 ~ "Low", 
      TRUE ~ "Moderate"
    )
  )
```

```{r tray test lesion}
# Tray Test
hist(tray.test$lesion_length.cm)  

fm.tray.test <- lm(lesion_length.cm ~ line, data = tray.test) 
summary(fm.tray.test) 

plot(fm.tray.test) #data not normal
trans <- boxcox(fm.tray.test) 
trans$x[which.max(trans$y)]
boxc.tran <- make.tran("boxcox", 0.2626)

fm.tray.test<- with(boxc.tran, 
                lm(linkfun(lesion_length.cm) ~ line, data = tray.test))
summary(fm.tray.test) # differences in lesion length 

mean.lesion <- emmeans(fm.tray.test, ~ line, type = "response") #obtain back-transformed emmmeans    
mean.lesion %>% 
  cld.emmGrid()

# dunnetts to compare against moderately susceptible check (Williams)
line.vs.will <- emmeans(fm.tray.test, trt.vs.ctrlk ~ line, type = "response")
line.vs.will <- tidy(line.vs.will$contrasts)

# compare against resistant check (L76-1988)
line.vs.L76 <- emmeans(fm.tray.test, trt.vs.ctrlk ~ line, type = "response", ref = 1)
line.vs.L76 <- tidy(line.vs.L76$contrasts)
```
