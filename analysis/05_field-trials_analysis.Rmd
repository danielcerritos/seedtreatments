---
title: "Seed treatment field trials analysis"
author: "Daniel Cerritos"
date: "12/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      fig.align = "center",
                      dev = "png",
                      cache = FALSE, 
                      message = FALSE)

```

```{r library, message=FALSE}
library(tidyverse) 
library(here)
library(lme4) 
library(lmerTest) 
library(emmeans) 
library(multcompView) 
library(broom) 
library(cowplot) 
library(ggResidpanel)
library(ggsignif)
theme_set(theme_bw())
```

# Import data files  
```{r import field trials data}
(seed.treatments.data <- list.files(path = here("output", "transform_data"), 
                         full.names = TRUE))
  
illinois.2017 <- read.csv(seed.treatments.data[[2]]) 
urbana.2018 <- read.csv(seed.treatments.data[[3]])
iowa <- read.csv(seed.treatments.data[[1]])
```

# Multilocation field trials 2017 

## Multilocation Analysis 

Fit mixed model for 2017 field trials

```{r model vc 2017, results='asis'}
illinois.2017$block <- as.factor(illinois.2017$block) # set block as factor

fm.illinois.vc <- lmer(vc_plants.m2 ~ location * variety * treatment + (1|block:location) + (1|whole_plot), 
                       data = illinois.2017)
anova(fm.illinois.vc) 
```

```{r vc means, fig.height=2, fig.width=6}
emmeans(fm.illinois.vc,  ~ treatment) %>% 
  plot(comparisons = TRUE) # increase of 12.88%
```

Bars are confidence intervals and arrows are for comparisons. Arrows that overlap are not significant different. 

```{r model v2 2017, message=F}
fm.illinois.v2 <- lmer(v2_plants.m2 ~ location*variety*treatment + (1|block:location) + (1|whole_plot), 
                       data = illinois.2017)
anova(fm.illinois.v2)
```

```{r v2 means 2017, fig.height=2, fig.width=6}
emmeans(fm.illinois.v2, pairwise ~ treatment) %>%   
  plot(comparisons = TRUE) # increase of 8.22%
```

```{r model yield 2017}
fm.illinois.yield <- lmer(yield_kg.ha ~ location * variety * treatment + (1|block:location) + (1|whole_plot), 
                          data = illinois.2017)
anova(fm.illinois.yield) 
```

```{r yield mean 2017, fig.height=2, fig.width=6}
emmeans(fm.illinois.yield, pairwise ~ treatment) %>% 
  plot(comparisons = TRUE)
```

The seed treatment significantly increased early stands (VC and V2), but no effect was  
observed for yield. 

## Analysis by location 

Location and location by variety were significant for all varibles. An analysis by  
location would be perform to see if specific varieties perform better in a  
particular environment.

```{r 2017 data by location}
# change whole_plot column by removing location nested in block
whole.plot <- function(data){
  data %>% 
    mutate(whole_plot = paste(block, variety, sep = ":"))
}

monmouth <- illinois.2017 %>% 
  filter(location == "Monmouth") %>% 
  whole.plot() 

orr <- illinois.2017 %>% 
  filter(location == "Orr") %>% 
  whole.plot()

urbana <- illinois.2017 %>% 
  filter(location == "Urbana") %>% 
  whole.plot()
```

### Monmouth 

```{r fit models monmouth}
fm.mon.vc <- lmer(vc_plants.m2 ~ variety*treatment + (1|block) + (1|whole_plot), 
                  data = monmouth)
fm.mon.v2 <- lmer(v2_plants.m2 ~ variety*treatment + (1|block) + (1|whole_plot), 
                  data = monmouth)
fm.mon.yield <- lmer(yield_kg.ha ~ variety*treatment + (1|block) + (1|whole_plot), 
                     data = monmouth)
anova(fm.mon.vc) 
anova(fm.mon.v2)
anova(fm.mon.yield) 
```

#### Treatment comparisons 

I will focus in VC because both treatment and variety were significant. 

```{r vc monmouth, fig.height= 9, fig.width=6}
emmeans(fm.mon.vc, ~ treatment|variety) %>% 
  plot(comparisons =TRUE) 
```

LD11-10069 (Rps1c, moderate) is the only variety with significant differences  
between control and treatment.

#### Yield comparisons

No effect of seed treatment on yield so I would only compare yield between  
varieties.

```{r yield monmouth}
emmeans(fm.mon.yield, ~ variety) %>% 
  cld.emmGrid()
```

Varieties with Rps don't seem to perform better than varieties with no  
gene (rps). High to moderate levels have higher yields than low level.

#### Contrasts

I will group varieties by gene and by levels of partial resistance.  
Then do some contrasts betweem the seed treatment and control  
to see the overrall effect of the seed treatment by type of resistance.

```{r means monmouth}
m.mon.vc <- emmeans(fm.mon.vc, ~ variety:treatment) 
m.mon.yield <- emmeans(fm.mon.yield, ~ variety:treatment)
```

```{r custom contrast}
custom_contrasts <- function(lsmeans){
  # by Rps
  cons.1 <- list(
    "t.rps - c.rps" = c(-0.5, -0.5, rep(0, 5), 0.5, 0.5, rep(0, 5)),
    "t.Rps1c - c.Rps1c" = c(0, 0, -1/3, 0, 0, -1/3, -1/3, 0, 0, 1/3, 0, 0, 1/3, 1/3),
    "t.Rps1k - c.Rps1k" = c(rep(0, 3), -0.5, -0.5, rep(0, 5), 0.5, 0.5, 0, 0))
  # by partial resistance level
  cons.2 <- list(
    "t.High - c.High" = c(-0.5, rep(0, 5), -0.5, 0.5, rep(0, 5), 0.5), 
    "t.Moderate - c.Moderate" = c(0, rep(-0.25, 4), rep(0, 3), rep(0.25, 4), 0, 0), 
    "t.Low - c.Low" = c(rep(0, 5), -1, rep(0, 6), 1, 0)
  )
  cus.con1 <- contrast(lsmeans, cons.1, adjust = "mvt") # adjustment for mutiple testing
  cus.con2 <- contrast(lsmeans, cons.2, adjust = "mvt") 
  l <- c(cus.con1, cus.con2)
  l.m <- map(l, summary, infer = TRUE) # confidence intervals
  df_1 <- as.data.frame(l.m[[1]])
  df_2 <- as.data.frame(l.m[[2]])
  df_all <- rbind(df_1, df_2)
  df_all
}
```

Keep focusing only in stand VC and yield.

```{r effect monmouth}
custom_contrasts(m.mon.vc)
custom_contrasts(m.mon.yield)
```

Significant differences for Rps1c at VC, no differences for levels of partial resistance (PR).  
At yield, differences for Rps1k and no differences for PR levels.

I would do another contrast comparing yields between levels of PR. Rps  
didn't seem to perform better than rps, but high PR seem to perform better.

```{r pr level monmouth}
pr_contrast <- function(lsmean){
  cons.3 <- list(
  "High - Low" = c(0.5, 0, 0, 0, 0, -1, 0.5),
  "High - Moderate" = c(0.5, -0.25, -0.25, -0.25, -0.25, 0, 0.5),
  "Moderate - Low" = c(0, 0.25, 0.25, 0.25, 0.25, -1, 0)
  )
  cus.con.3 <- contrast(lsmean, cons.3, adjust = "mvt")
  conf_con <- summary(cus.con.3, infer = TRUE)
  df_con <- as.data.frame(conf_con)
  df_con
}

emmeans(fm.mon.yield, ~ variety) %>% 
  pr_contrast()
```

### Orr

```{r fit models orr}
fm.orr.vc <- lmer(vc_plants.m2 ~ variety*treatment + (1|block) + (1|whole_plot), 
                  data = orr)
fm.orr.v2 <- lmer(v2_plants.m2 ~ variety*treatment + (1|block) + (1|whole_plot), 
                  data = orr)
fm.orr.yield <- lmer(yield_kg.ha ~ variety*treatment + (1|block) + (1|whole_plot), 
                     data = orr)
anova(fm.orr.vc) 
anova(fm.orr.v2) 
anova(fm.orr.yield) 
```

#### Treatment comparison  

```{r vc orr, fig.height = 9.5, fig.width = 6}
emmeans(fm.orr.vc, ~ treatment|variety) %>% 
  plot(comparisons =TRUE) 
```

Only one variety (LD12-15156R1a) had a significant difference between seed treatment and control.

#### Yield comparison

```{r yield orr}
emmeans(fm.orr.yield, ~ variety) %>% 
  cld.emmGrid() 
```

Same as Monmouth, variety with no resistance gene has the higher yield.

#### Contrasts

```{r effect orr}
emmeans(fm.orr.vc, ~ variety:treatment) %>% 
  custom_contrasts()

emmeans(fm.orr.yield, ~ variety:treatment) %>% 
  custom_contrasts()
```

Rps1k had a significant difference at VC and differences for moderate and low.  
No significant differences for yield.

```{r pr level orr}
emmeans(fm.orr.yield, ~ variety) %>% 
  pr_contrast()
```

High PR has higher yields than both moderate and low. 

### Urbana

```{r fit models urbana}
fm.urb.vc <- lmer(vc_plants.m2 ~ variety*treatment + (1|block) + (1|whole_plot), 
                  data = urbana)
fm.urb.v2 <- lmer(v2_plants.m2 ~ variety*treatment + (1|block) + (1|whole_plot),
                  data = urbana)
fm.urb.yield <- lmer(yield_kg.ha ~ variety*treatment + (1|block) + (1|whole_plot),
                     data = urbana)
anova(fm.urb.vc)
anova(fm.urb.v2) 
anova(fm.urb.yield) 
```

A significant interaction was observed for VC in Urbana.
```{r interaction urbana, fig.width=8, fig.height=4}
emmip(fm.urb.vc, treatment ~ variety)
```

Seems that seed treatment is having an effect in both rps and Rps1k. 

#### Treatment comparison 

```{r vc urbana, fig.height = 9.5, fig.width = 6}
emmeans(fm.urb.vc, ~ treatment|variety) %>% 
  plot(comparisons =TRUE) 
```

No significant difference for two of the the three Rps1c varieties. 

#### Yield comparison

```{r yield urbana}
emmeans(fm.urb.vc, ~ variety) %>% 
  cld.emmGrid()
```

A Rps1c variety has the highest yield.

#### Contrasts

```{r per level urbana}
emmeans(fm.urb.vc, ~ variety:treatment) %>% 
  custom_contrasts
emmeans(fm.urb.yield, ~ variety:treatment) %>% 
  custom_contrasts()
```

Significant differences for rps and Rps1k for VC and for all pr levels at VC.  
No significant differences for yield

```{r pr level urbana}
emmeans(fm.urb.yield, ~ variety) %>% 
  pr_contrast()
```

### Model assumptions

```{r assumptions, results = "hide"}
# diagnostic plots to check on model assumptions 
models.2017 <- list(fm.mon.vc, fm.mon.v2, fm.mon.yield, 
                    fm.orr.vc, fm.orr.v2, fm.orr.yield,
                    fm.urb.vc, fm.urb.v2, fm.urb.yield)
map(models.2017, resid_panel) #residuals normally distributed and homogenicity of variance
```

### Figure 1

```{r add resistance info}
# add resistance information (Rps and partial resistance levels) for figures
resistance_info <- function(dataf) {
  rps <- c("LD07-3395bf","LD10-10219","LD13-13478R1a")
  rps1k <- c("LD11-13802R2", "LD11-7311", "H2512NX", "H2862NX")
  low <- c("LD12-15064R1a", "LD12-15129R1a", "LD13-13478R1a", "LD12-15156R1a")
  high <- c("LD07-3395bf", "LD13-14071R2", "C2888RX", "C3140RX")
  
  dataf %>% 
    mutate(
      rps = case_when(
        variety %in% rps ~ "rps",
        variety %in% rps1k ~ "Rps1k",
        TRUE ~ "Rps1c"),
      pr_level = case_when(
        variety %in% low ~ "Low",
        variety %in% high  ~ "High",
        TRUE ~ "Moderate"))
}
```

```{r fig 1 labels}
# treatment comparisons 
lab.fig.1 <- data.frame(variety = c("LD11-10069", "LD12-15156R1a",
                                "LD07-3395bf", "LD10-10219", 
                                "LD12-15156R1a", "LD11-13802R2",
                                "LD11-7311"), 
                    rps= c("Rps1c", "Rps1c", "rps", "rps", "Rps1c", 
                           "Rps1k", "Rps1k"),
                    location = c("Monmouth", "Orr", "Urbana", "Urbana", 
                                 "Urbana", "Urbana", "Urbana"),
                    label = c("*", "*", "*", "*", "*", "*", "*"), 
                    vc_plants.m2 = c(28, 29, 35, 36, 34, 34, 32), 
                    treatment = c("intego", "intego", "intego", "intego",
                                  "intego", "intego","intego")) 
# contrasts
con.fig.1 <- data.frame(location = c("Monmouth", "Orr", 
                                     "Urbana", "Urbana"), 
                        rps = c("Rps1c", "Rps1k", 
                                "rps", "Rps1k"), 
                        start = c("LD11-10069", "LD11-13802R2", 
                                  "LD07-3395bf", "LD11-13802R2"), 
                        end = c("LD13-14071R2", "LD11-7311", 
                                "LD10-10219", "LD11-7311"), 
                          y = c(34, 34, 41, 39), 
                        label = c("* *", "* *", "* *", "* *"), 
                        treatment = c("intego", "intego", 
                                      "intego", "intego"))
# shorter varieties names
short.names <- c("LD10-10219" = "LD10-10", 
                 "LD13-13478R1a" = "LD13-13",
                 "LD07-3395bf" = "LD07-33", 
                 "LD12-15064R1a" = "LD12-150",
                 "LD12-15129R1a" = "LD12-151a",
                 "LD11-10069" = "LD11-10",
                 "LD13-14071R2" = "LD13-14",
                 "LD12-15156R1a" = "LD12-151", 
                 "LD11-13802R2" = "LD11-13",
                 "LD11-7311" = "LD11-73") 

```

```{r fig 1, warning = FALSE, fig.width = 7, fig.height = 6}
illinois.2017 %>% 
  resistance_info() %>% 
  ggplot(aes(x = variety, y = vc_plants.m2)) +
    geom_point(aes(color = treatment), 
               position = position_jitterdodge(dodge.width = 0.5), 
               alpha = 0.2) +
    stat_summary(fun.data = "mean_cl_boot", 
                 position = position_dodge(width = 0.5),
                 aes(color = treatment), alpha = 0.7) + 
  facet_grid(location ~ rps, scales = "free", space = "free_x") +
  labs(y = expression('Stand (plants m'^-2*')')) +
  theme_cowplot() +
  panel_border() +
  theme(panel.grid.major.y = element_line(linetype = "dotted", 
                                          color = "grey80"), 
        legend.position = "bottom") +
  scale_color_manual(values = c("#D55E00", "#0072B2"), 
                     labels = c("NTC", "ST"), 
                     name = element_blank()) +
  scale_x_discrete("Variety", labels = short.names) +
  geom_text(data = lab.fig.1, aes(label=label), 
            size = 5, color = "black") +
  geom_signif(data = con.fig.1, 
              aes(xmin = start, xmax = end, annotations=label, y_position = y),
              textsize = 5, vjust = -0.2, 
              manual = TRUE) +
  scale_y_continuous(limits = c(15, 45))
```

#

```{r fig 2}

```









### Figure 2


```{r stand means figure}
# figure to see stand means by variety
fig_means <- function(data, y, label.data){
  ggplot(data = data, aes(x = variety, y = y, color = treatment)) +
    geom_point(position = position_jitterdodge(dodge.width = 0.5), alpha = 0.2)+
    stat_summary(fun.data = "mean_cl_boot", 
                 position = position_dodge(width = 0.5),
                 aes(color = treatment), alpha = 0.7) +
    scale_color_manual(values = c("#D55E00", "#0072B2"), 
                       labels = c("NTC", "ST"), 
                       name = element_blank()
    ) +
    scale_x_discrete("Variety", labels = c("LD10-10219" = "LD10-10", "LD13-13478R1a" = "LD13-13",
                                           "LD07-3395bf" = "LD07-33", "LD12-15064R1a" = "LD12-150",
                                           "LD12-15129R1a" = "LD12-151a",
                                           "LD11-10069" = "LD11-10","LD13-14071R2" = "LD13-14",
                                           "LD12-15156R1a" = "LD12-151", "LD11-13802R2" = "LD11-13",
                                           "LD11-7311" = "LD11-73") # shorter lines names to fit them 
    ) +
    geom_text(data = label.data, aes(label=label), 
              size = 6.5, color = "black")
}
```

```{r theme 2017}
# theme for 2017 data
theme_stand.17 <- function (base_size = 11, base_family = "") {
    theme_bw() %+replace% 
    theme_cowplot() +
    panel_border() +
    theme(
      strip.text = element_text(size = rel(1.2)),
      axis.title.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.y = element_text(size = rel(1.2)),
      axis.text.y = element_text(size = rel(1.2)),
      panel.grid.major.y = element_line(linetype = "dotted", 
                                        color = "grey80")
    ) 
}
```

```{r resistance info}

```


```{r figure 1, fig.height=6, fig.width=8}
#figure 1
illinois.2017 <- resistance(illinois.2017)

#label data
lab.1 <- data.frame(variety = c("LD11-10069", "LD12-15156R1a",
                              "LD07-3395bf", "LD10-10219", 
                              "LD12-15156R1a", "LD11-13802R2",
                              "LD11-7311"), 
                  Rps= c("Rps1c", "Rps1c", "rps", "rps", "Rps1c", 
                         "Rps1k", "Rps1k"),
                  location = c("Monmouth", "Orr", "Urbana", "Urbana", 
                               "Urbana", "Urbana", "Urbana"),
                  label = c("*", "*", "*", "*", "*", "*", "*"), 
                  y = c(27, 26, 31, 33, 31.5, 31.5, 31), 
                  treatment = c("intego", "intego", "intego", "intego",
                                "intego", "intego","intego")) 

# stand means by variety in 2017 multilocation field trials
fig_means(illinois.2017, illinois.2017$stand.vc, lab.1) 
```




# Urbana and Boone field trials in 2018


## Urbana 2018

```{r fit models for 2018 data}
urbana.2018$block <- as.factor(urbana.2018$block)

fm.urb18.vc <- lmer(stand.vc ~ variety * treatment + (1|block) + (1|whole_plot), data = urbana.2018)
fm.urb18.v2 <- lmer(stand.v2 ~ variety * treatment + (1|block) + (1|whole_plot), data = urbana.2018)
fm.urb18.v4 <- lmer(stand.v4 ~ variety * treatment + (1|block) + (1|whole_plot), data = urbana.2018)
fm.urb18.r8 <- lmer(stand.r8 ~ variety * treatment + (1|block) + (1|whole_plot), data = urbana.2018)
fm.urb18.yield <- lmer(yield.kg_ha ~ variety * treatment + (1|block) + (1|whole_plot), data = urbana.2018)

a.4 <- anova(fm.urb18.vc) %>% 
  tidy()
anova(fm.urb18.v2) 
anova(fm.urb18.v4)  
anova(fm.urb18.r8) 
a.5 <- anova(fm.urb18.yield) %>% 
  tidy()

anovas.2 <- rbind(a.4, a.5)

write_csv(anovas.2, path = here("Results", "anovas_18.csv"))

```

### Estimate emmeans Urbana 2018

```{r treatment means urbana 18}
# overrall treatment effect
emmeans(fm.urb18.vc, pairwise ~ treatment) #17.82%
emmeans(fm.urb18.v2, pairwise ~ treatment) #18.61
emmeans(fm.urb18.v4, pairwise ~ treatment) #18.35
emmeans(fm.urb18.r8, pairwise ~ treatment) #15.6
emmeans(fm.urb18.yield, pairwise ~ treatment) #7.84
```

```{r variety means urbana 18}
# seed treatment effect within variety
#VC
emmeans(fm.urb18.vc, ~ treatment|variety) %>% 
  cld.emmGrid() # two varieties 
#Yield
emmeans(fm.urb18.yield, ~ treatment|variety) %>% 
  cld.emmGrid() #two varieties

m.urb18.yield.var <-emmeans(fm.urb18.yield, ~ variety) 
m.urb18.yield.var %>% 
  cld.emmGrid() 
```

### Constrasts Urbana 2018

```{r effect size Rps urb 18}
# compare effect size for each Rps 
m.urb18.vc <- emmeans(fm.urb18.vc, ~ variety:treatment)
(m.urb18.yield <- emmeans(fm.urb18.yield, ~ variety:treatment)) 
cons.1.18 <- list(
  "t.rps - c.rps" = c(-1/3, -1/3, rep(0, 5), -1/3, 0, 1/3, 1/3, rep(0, 5), 1/3, 0),
  "t.Rps1c - c.Rps1c" = c(rep(0, 4), -0.25, -0.25, -0.25, 0, -0.25, rep(0, 4), 0.25, 0.25, 0.25, 0, 0.25),
  "t.Rps1k - c.Rps1k" = c(rep(0, 2), -0.5, -0.5, rep(0, 7), 0.5, 0.5, rep(0, 5))
)

rps.urb18.vc <- contrast(m.urb18.vc, cons.1.18, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Urbana 2018", 
         variable = "VC")

rps.urb18.yield <- contrast(m.urb18.yield, cons.1.18, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Urbana 2018", 
         variable = "Yield")
```

```{r effect size PR urb 18}
# seed treatment effect by PR level
cons.2.18 <- list(
  "t.High - c.High" = c(-0.5, rep(0, 7), -0.5, 0.5, rep(0, 7), 0.5), 
  "t.Moderate - c.Moderate" = c(0, rep(-1/3, 3), rep(0, 6), rep(1/3, 3), rep(0, 5)), 
  "t.Low - c.Low" = c(rep(0, 4), rep(-1/4, 4), rep(0, 5), rep(1/4, 4), 0)
)
pr.urb18.vc <- contrast(m.urb18.vc, cons.2.18, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Urbana 2018", 
         variable = "VC")

pr.urb18.yield <- contrast(m.urb18.yield, cons.2.18, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Urbana 2018", 
         variable = "Yield")
```

```{r contrast PR urb 18}
# compare yields b/w PR levels
m.urb18.yield.var <-emmeans(fm.urb18.yield, ~ variety) 
cons.3.18 <- list(
  "High - Low" = c(0.5, 0, 0, 0, -1/3, -1/3, 0, -1/3, 0.5),
  "High - Moderate" = c(0.5, -0.25, -0.25, -0.25, 0, 0, -0.25, 0, 0.5),
  "Moderate - Low" = c(0, 0.25, 0.25, 0.25, -1/3, -1/3, 0.25, -1/3, 0)
)
pr.urb18.yield.2 <- contrast(m.urb18.yield.var, cons.3.18, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Urbana 2018", 
         variable = "Yield")

m.urb18.yield.var %>% 
  cld.emmGrid() 
```

### Figure 3
## Boone, Iowa 2018

```{r boone fit models}
iowa$block <- as.factor(iowa$block)

fm.iowa.vc <- lmer(stand.vc ~ variety * treatment + (1|block) + (1|whole_plot), data = iowa)
fm.iowa.v1<- lmer(stand.v1 ~ variety * treatment + (1|block) + (1|whole_plot), data = iowa)
fm.iowa.r2 <- lmer(stand.v2 ~ variety * treatment + (1|block) + (1|whole_plot), data = iowa)
fm.iowa.r8 <- lmer(stand.r8 ~ variety * treatment + (1|block) + (1|whole_plot), data = iowa)
fm.iowa.yield <- lmer(yield.kg_ha ~ variety * treatment + (1|block) + (1|whole_plot), data = iowa)

anova(fm.iowa.vc) 
anova(fm.iowa.v1)
anova(fm.iowa.r2)  
anova(fm.iowa.r8) 
anova(fm.iowa.yield)
```

```{r emmeans boone treatment}
emmeans(fm.iowa.vc, pairwise ~ treatment) #12.25
emmeans(fm.iowa.v1, pairwise ~ treatment) #9.62
emmeans(fm.iowa.r2, pairwise ~ treatment) #11.10
emmeans(fm.iowa.r8, pairwise ~ treatment) #12.01
emmeans(fm.iowa.yield, pairwise ~ treatment) #8.1
```

```{r emmeans var}
# variety effect was not significant, see vc and yield like in other locations
emmeans(fm.iowa.vc, ~ treatment|variety) %>% 
  cld.emmGrid() #one variety

emmeans(fm.iowa.yield, ~ treatment|variety) %>% 
  cld.emmGrid() #one variety
```

### Custom contrasts Boone, IA 
- no sig variety effect, but still going to do comparisons to be consistant with analysis

```{r Rps contrast IA}
m.iowa.vc <- emmeans(fm.iowa.vc, ~ variety:treatment)
(m.iowa.yield <- emmeans(fm.iowa.yield, ~ variety:treatment))
# compare effect of seed treatment by Rps
cons.1.iw <- list(
  "t.Rps1c - c.Rps1c" = c(-0.2, -0.2, -0.2, 0, 0, -0.2, -0.2, 0.2, 0.2, 0.2, 0, 0, 0.2, 0.2),
  "t.Rps1k - c.Rps1k" = c(0, 0, 0, -0.5, -0.5, 0, 0, 0, 0, 0, 0.5, 0.5, 0, 0)
)
rps.iw.vc <- contrast(m.iowa.vc, cons.1.iw, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Iowa", 
         variable = "VC")
rps.iw.yield <- contrast(m.iowa.yield, cons.1.iw, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Iowa", 
         variable = "Yield")
```

```{r contrasts PR level IA}
cons.2.iw <- list(
  "t.High - c.High" = c(0, 0, -0.5, 0, 0, 0, -0.5, 0, 0, 0.5, 0, 0, 0, 0.5), 
  "t.Moderate - c.Moderate" = c(-1/5, -1/5, 0, -1/5, -1/5, -1/5, 0, 1/5, 1/5, 0, 1/5, 1/5, 1/5, 0)
)

pr.iw.vc <- contrast(m.iowa.vc, cons.2.iw, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Iowa", 
         variable = "VC")
pr.iw.yield <- contrast(m.iowa.yield, cons.2.iw, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Iowa", 
         variable = "Yield")
```

```{r contrast b/w PR level IA}
m.iowa.yield.var <- emmeans(fm.iowa.yield, ~ variety)
cons.3.iw <- list(
  "High - Moderate" = c(-1/5, -1/5, 0.5, -1/5, -1/5, -1/5, 0.5)
)
pr.iw.yield.2 <- contrast(m.iowa.yield.var, cons.3.iw, adjust = "mvt") %>% 
  summary(infer = TRUE) %>% 
  as.data.frame() %>% 
  mutate(location = "Iowa", 
         variable = "Yield")

m.iowa.yield.var %>% 
  cld.emmGrid() 
```

```{r save 2018 contrasts}

contrasts.2018 <- rbind(rps.urb18.vc, rps.urb18.yield, 
                        pr.urb18.vc, pr.urb18.yield, pr.urb18.yield.2, 
                        rps.iw.vc, rps.iw.yield, 
                        pr.iw.vc, pr.iw.yield, pr.iw.yield.2)

write_csv(contrasts.2018, path = here("Results", "Contrasts_2018.csv"))
```


### Figure 4







```{r yield distribution PR figure}
# boxplots for yield by PR levels
fig_box.plot <- function(data){
  ggplot(data = data, aes(x = variety, y = yield.kg_ha, fill= PR)
  ) +
    geom_jitter(alpha= 0.2, width = 0.4
    ) +
    theme_cowplot() +
    panel_border() +
    theme( 
          strip.text = element_text(size = rel(1.2)),
          axis.ticks.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = rel(1.2)),
          axis.text.y = element_text(size = rel(1.2)),
          panel.grid.major.y = element_line(linetype = "dotted", 
                                            color = "grey80")
    ) +
    labs(y = expression('Yield (kg ha'^-1*')'),
         x = "Variety") +
    scale_x_discrete("Variety", labels = c("LD10-10219" = "LD10-10", "LD13-13478R1a" = "LD13-13",
                                           "LD07-3395bf" = "LD07-33", "LD12-15064R1a" = "LD12-150",
                                           "LD12-15129R1a" = "LD12-151a",
                                           "LD11-10069" = "LD11-10","LD13-14071R2" = "LD13-14",
                                           "LD12-15156R1a" = "LD12-151", "LD11-13802R2" = "LD11-13",
                                           "LD11-7311" = "LD11-73")
    ) +
    scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73" ), 
                      name = element_blank(),
                      )+
    geom_boxplot(alpha = 0.5) +
  stat_summary(fun.y="mean", geom="point", size=1.2,
               position=position_dodge(width=0.75), color="black")
  
}
```

```{r figure 2, fig.height= 7, fig.width=10}
# Figure 2 
illinois.2017$PR <- factor(illinois.2017$PR, levels = c("High", 
                                                        "Moderate", 
                                                        "Low")
                           ) # change order for figure
# label data
lab.2 <- data.frame(variety = c("LD07-3395bf", "LD10-10219",
                                "LD11-10069", "LD12-15156R1a", "LD13-14071R2",
                               "LD07-3395bf", "LD10-10219", 
                               "LD11-10069", "LD12-15156R1a", "LD13-14071R2",
                               "LD11-13802R2", "LD11-7311"), 
                  Rps= c("rps", "rps", 
                         "Rps1c", "Rps1c", "Rps1c", 
                         "rps", "rps", 
                         "Rps1c", "Rps1c", "Rps1c", 
                         "Rps1k", "Rps1k"),
                  location = c("Orr", "Orr", 
                               "Orr", "Orr", "Orr", 
                               "Urbana", "Urbana", 
                               "Urbana", "Urbana","Urbana", 
                               "Urbana", "Urbana"),
                  label = c("a", "b",
                            "a", "b", "a",
                            "a", "b", 
                            "a", "b", "a",
                            "b", "a"), 
                  yield.kg_ha = c(6000, 5700, 
                                 5700, 5350, 5600, 
                                 6000, 5550, 
                                 5955, 5300, 5850, 
                                 5450, 5900), 
                  PR = c("High", "Moderate", 
                         "Moderate", "Low", "High", 
                         "High", "Moderate", 
                         "Moderate", "Low", "High",
                         "Moderate", "Moderate")
                  ) 

# yield by PR levels for 2017 data
fig_box.plot(illinois.2017) +
  facet_grid(location ~ Rps, scales = "free_x", space = "free") +
  geom_text(data = lab.2, aes(label=label), 
            size = 5, color = "black")
```

```{r themes 2018}
# theme 2018 stand data
theme_stand.18 <- function (base_size = 11, base_family = "") {
    theme_bw() %+replace% 
    theme_cowplot() +
    panel_border() +
    theme( legend.position = "none", 
      strip.text = element_text(size = rel(1.2)),
      axis.title.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.y = element_text(size = rel(1.2)),
      axis.text.y = element_text(size = rel(1.2)),
      axis.text.x = element_blank(), 
      panel.grid.major.y = element_line(linetype = "dotted", 
                                        color = "grey80")
    ) 
  }

# theme 2018 yield data
theme_yield.18 <- function (base_size = 11, base_family = "") {
    theme_bw() %+replace% 
    theme_cowplot() +
    panel_border() +
    theme(legend.justification = "top", 
      strip.text = element_blank(),
      axis.title.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.title.y = element_text(size = rel(1.2)),
      axis.text.y = element_text(size = rel(1.2)),
      panel.grid.major.y = element_line(linetype = "dotted", 
                                        color = "grey80")
    ) 
}
```

```{r Figure 3, fig.height= 7.5, fig.width=10.5}
# Urbana 2018 data
urbana.2018 <- resistance(urbana.2018)

# label Fig 3A
lab.u.1 <- data.frame(variety = c("LD07-3395bf", "LD11-7311"), 
                  Rps= c("rps", "Rps1k"),
                  label = c("*", "*"), 
                  y = c(27, 27), 
                  treatment = c("intego", "intego")
                  ) 

# figure 3A: stands
u.1 <- fig_means(urbana.2018, urbana.2018$stand.vc, lab.u.1) + 
  facet_grid(. ~ Rps, scales = "free_x", space = "free") +
  labs(y = expression('Stand (plants m'^-2*')')
       ) +
  theme_stand.18()

# label Fig 3B
lab.u.2 <- data.frame(variety = c("LD07-3395bf", "LD13-14071R2"), 
                      Rps= c("rps", "Rps1c"),
                      label = c("*", "*"), 
                      y = c(4000, 4400), 
                      treatment = c("intego", "intego")
                      ) 
# figure 3B: yields 
# showing yields for 2018 data because seed treatmnet was significant for yield
u.2 <- fig_means(urbana.2018, urbana.2018$yield.kg_ha, lab.u.2) + 
  facet_grid(. ~ Rps, scales = "free_x", space = "free") +
  labs(y = expression('Yield (kg ha'^-1*')')
       ) +
  theme_yield.18()

# label Figure 3C
lab.u.3 <- data.frame(variety = c("LD12-15064R1a", "LD12-15129R1a", "LD12-15156R1a", 
                                    "LD13-14071R2"), 
                        Rps= c("Rps1c", "Rps1c", "Rps1c", "Rps1c"),
                        label = c("c", "bc",
                                  "b", "a"), 
                        yield.kg_ha = c(3550, 3200, 3600, 4500  
                        ), 
                        PR = c("Low", "Low", "Low", "High")
                        )

# Figure 3C: Yields by PR
urbana.2018$PR <- factor(urbana.2018$PR, levels = c("High", 
                                                    "Moderate", 
                                                    "Low")
                         )

u.3 <- fig_box.plot(urbana.2018) +
  facet_grid(. ~ Rps, scales = "free_x", space = "free")  +
  geom_text(data = lab.u.3 , aes(label=label), 
            size = 5, color = "black")

# Figure 3 combine
cowplot::plot_grid(u.1, u.2, u.3,
                   ncol = 1, 
                   align = "v", 
                   labels = "AUTO", 
                   axis = "lr" )
```

```{r Figure 4, fig.height= 7.5, fig.width=10.5}
# Boone, Iowa 2018 data
iowa <- resistance(iowa)

# label Fig 4A
lab.iw.1 <- data.frame(variety = c("C3140RX"), 
                      Rps= c("Rps1c"),
                      label = c("*"), 
                      y = c(12.6), 
                      treatment = c("intego")
                     ) 
# Fig 4A
iw.1 <- fig_means(iowa, iowa$stand.vc, lab.iw.1) + 
  facet_grid(. ~ Rps, scales = "free_x", space = "free") +
  labs(y = expression('Stand (plants m'^-2*')')
       ) +
  theme_stand.18()

# label Fig 4B
lab.iw.2 <- data.frame(variety = c("C3140RX"), 
                     Rps= c("Rps1c"),
                     label = c("*"), 
                     y = c(3100), 
                     treatment = c("intego")
                     ) 
# Fig 4B
iw.2 <- fig_means(iowa, iowa$yield.kg_ha, lab.iw.2) + 
  facet_grid(. ~ Rps, scales = "free_x", space = "free") +
  labs(y = expression('Yield (kg ha'^-1*')')
       ) +
  theme_yield.18()

# Figure 4C
iw.3 <- fig_box.plot(iowa) +
  facet_grid(. ~ Rps, scales = "free_x", space = "free")

# Figure 4 combine
cowplot::plot_grid(iw.1, iw.2, iw.3,
                   ncol = 1, 
                   align = "v", 
                   labels = "AUTO", 
                   axis = "lr" )
```